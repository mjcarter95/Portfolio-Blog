---
import BaseLayout from "@/layouts/BaseLayout.astro";
import HeroHeader from "@/components/HeroHeader.astro";
import { getCollection } from "astro:content";
import readingTime from "reading-time";
import { slugifyTag } from "@/utils/tags";

export async function getStaticPaths() {
  const studies = await getCollection("case-studies", ({ data }) => !data.draft);
  return studies.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const rt = readingTime(entry.body ?? "");
const readMinutes = Math.max(1, Math.round(rt.minutes));
const { Content } = await entry.render();
const hero = entry.data.heroImage;
---

<BaseLayout title={`${entry.data.title} â€” Case Study`}>
  <HeroHeader
    title={entry.data.title}
    subtitle={entry.data.summary}
    backgroundImage={hero}
  >
    <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-white/80">
      <time datetime={entry.data.date.toISOString()}>
        {entry.data.date.toLocaleDateString("en-GB", { year: "numeric", month: "long", day: "2-digit" })}
      </time>
      <span> &middot; {readMinutes} min read</span>
      {entry.data.tags?.length ? (
        <div class="flex gap-2 flex-wrap ml-2">
          {entry.data.tags.map((t) => (
            <a href={`/case-studies/tags/${slugifyTag(t)}/`} class="px-2 py-0.5 rounded bg-white/20 hover:bg-white/30 transition">
              {t}
            </a>
          ))}
        </div>
      ) : null}
    </div>

    <div class="mt-4 flex gap-3 flex-wrap">
      {entry.data.projectUrl && (
        <a href={entry.data.projectUrl} class="px-3 py-1 rounded bg-white text-black hover:bg-gray-100 transition text-sm" rel="noopener">
          View Project
        </a>
      )}
      {entry.data.repoUrl && (
        <a href={entry.data.repoUrl} class="px-3 py-1 rounded border border-white/70 text-white hover:bg-white hover:text-black transition text-sm" rel="noopener">
          View Repo
        </a>
      )}
    </div>
  </HeroHeader>

  <!-- BODY -->
  <article class="max-w-3xl mx-auto px-6 py-10">
    <div class="prose">
      <Content />
    </div>
  </article>
</BaseLayout>
